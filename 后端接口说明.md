# 后端接口说明

相关路径文件 `backend/urls.py`

由前端提出接口需求，后端实现

> wzk：
>
> ### POST请求
>
> * 每个views函数前面加上修饰：
>
>   ```python
>   @api_view(['POST'])
>   @authentication_classes([])  # 添加
>   ```
>
> * 每个函数返回值都写一个字典`res`，然后用`my_response(res)`封装成`HttpResponse(content_type="application/json")`进行返回
>
> * 建议每个函数套一个try， except里返回`errCode`和`msg`（python报错信息字符串），这样报错了在前端后端都能debug
> * 每个返回json都可以包含`success`、`errCode`和`msg`属性~~（即使这里可能没写）~~，前端所有请求只要`success=False`就会弹窗提示`errCode`和`msg`
>
> ### GET请求
>
> TODO



[TOC]



## 用户账户

### 用户登录 `login/`

#### POST

* 验证登录信息，在数据库中保存该用户信息，取得登录凭证`token`

* Request Body

  ```json
  {
  	'code' : "sdgajhbdsjfwbejkf", //wx.login生成的code，需后端转换成openid
  	'userInfo' : {} //内容参见https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/UserInfo.html
  }
  ```

* Success Response

  状态码 200
  
  ```json
  {
  	'status' : 0, 
  	'userExist' : 1, //0为新注册，1为已存在用户
      'token' : 'some random token', //服务器返回的登录凭证，缓存在本地
      'email' : 'abcdef@buaa.edu.cn' / '', //邮箱，如果还未认证邮箱则返回空串
      'id' :  'user.id', //用户的id，缓存在本地
      'avatar' : 'xxx.com', //用户头像的url
      'sign' : 'xxxxx', //个性签名
      'name' : 'xxx', //用户名
      
      
    //TODO:以下信息 在登录时直接返回？
      //还是每次点活动/组织页面时判断是否是管理员/是否关注等等
      'controlAct' : {
          [114514, 'name1'],
          [233333, 'name2']
      }, // 管理的活动列表，元素为id和名称，下面几个类似
  	'joinOrg' : {},
      'controlOrg' : {},
      
  }
  ```

- Error Response

  注：正常小程序运行过程不会发生，因为code是自动获取的。

  状态码 400

  ```json
  {
      'status' : 1,
      'errcode' : 'xxxxx', //微信服务接口返回的error code
      'msg' : 'xxxxxx', //微信服务接口返回的错误信息
  }
  ```

  



### 发送验证码邮件 `sendVerify/`

#### POST

* 向指定邮箱发送验证码，缓存中保存邮箱和验证码配对信息

- Request Body

  ```json
  {
  	"email" : "abcde@buaa.edu.cn"
  }
  ```

- Success Response

  状态码：200

	```json
  {
  	"status" : 0,
      "msg" : 'Email send',
  }
  ```





### 验证码验证 `verify/`

#### POST

验证用户输入的验证码是否和邮箱对应，对应则在数据库中保存用户的邮箱（以后登录则不必认证）

**Request Body**

```json
{
	"verifyCode" : "wzkwzk",  //验证码
    "email" : "abcde@buaa.edu.cn", //验证邮箱
    "id" : "user.id" //用户的id
}
```

**Success Response**

状态码：200

```json
{
	"status" : 0,
    "msg" : "Valid Code"
}
```

**Error Response**
状态码：400

```json
{
    "status" : 1,
    "msg" : "Incalid Code"
}
```



### 获得用户信息 TODO

* 获得用户的信息

* 参数

  ```json
  {
  	"token" : "some token"
  }
  ```

  

* 返回

  ```json
  {
      "email" : "aaa@buaa.edu.cn",
      "motto" : "苟利国家生死以", //描述/个性签名 
      "nickName" : "蛤蛤蛤", //昵称
      "avatarUrl" : "http://xxx", //头像图片链接
  }
  ```



### 提交用户反馈 TODO

* 提交反馈内容及联系方式

* 参数

  ```json
  {
  	"feedback" : "我们BUAA真是太厉害了！",
      "contact" : "微信wzk_1015"
  }
  ```

* 返回

  ```json
  {
      "success" : true,
      "msg" : "upload feedback succeed"
  }
  ```





## 版块

### 获取所有版块 GET  `blocks/`

获取所有版块的id和名称

**Request**

URL：http://127.0.0.1:8000/blocks/

Request Body：无

**Success Response**

状态码：200

Body：

```json
[
    {
        "id": 1,
        "name": "博雅"
    },
    {
        "id": 2,
        "name": "志愿"
    },
    {
        "id": 3,
        "name": "社团"
    }
]
```

**Error Response**

无

### 新建版块 POST `blocks/`

创建一个新的版块

**Request**

URL：http://127.0.0.1:8000/blocks/

Body：

```json
{
    "name" : "社团" //新建版块名称
}
```

**Success Response**

状态码：201

Body：

```json
{
    "id": 4, //新建版块的id
    "name": "社团" //新建版块的名称
}
```

**Error Response**

如果新的版块名称与已有版块名称重复

状态码：400

Body：

```json
{
    "name": [
        "具有 版块名称 的 block 已存在。"
    ]
}
```

### 修改版块 PUT `blocks/{id}/`

修改编号为id的版块

**Request**

URL：http://127.0.0.1:8000/blocks/4/（表示修改id=4的版块的名称）

Body：

```json
{
    "name" : "版块4" 
}
```

**Success Response**

状态码：200

Body：

```json
{
    "id": 4,
    "name": "版块4"
}
```

**Error Response**

①

如果修改后的版块名称与已有版块名称重复

状态码：400

Body：

```json
{
    "name": [
        "具有 版块名称 的 block 已存在。"
    ]
}
```

②

如果修改后和修改前的名称一致

状态码：400

Body：

```json
{
    "block": [
        "板块名称重复"
    ]
}
```

### 删除版块 DELETE `blocks/{id}/`

删除编号为id的版块

URL：http://127.0.0.1:8000/blocks/4/（表示删除id=4的版块）

Request Body：无

**Success Response**

状态码：204

Body：无

**Error Response**

对应id的版块不存在

状态码：404

Body：

```json
{
    "detail": "未找到。"
}
```

## 组织

### 组织申请 POST `organizations/applications/`









## GET

### 获取当前板块所有组织 `blocks/orgs/`

- 查看板块id下所有组织信息

  板块id与板块名称：{1：博雅，2：社团，3：学生会，4：志愿}

- 参数（放到query_params里如：http://127.0.0.1:8000/blocks/orgs/?block=1）

  ```json
  {
  	"block" : 1,
  }
  ```

- 返回

```json
{
    "status": 0,
    "msg": "ok",
    "results": [
        {
            "name": "Org1",
            "description": "this is Org1",
            "create_time": "2021-04-13T12:01:47.643533",
            "avatar": "url",
            "owner": {
                "id": 1,
                "openid": "12345",
                "name": "Jessica",
                "avatar": null,
                "email": "Jessica@qq.com",
                "sign": "just a little try"
            },
            "block": {
                "id": 1,
                "name": "博雅"
            }
        },
        {
            "name": "Org2",
            "description": "aba aba aba",
            "create_time": "2021-04-13T12:02:47.699920",
            "avatar": "url",
            "owner": {
                "id": 1,
                "openid": "12345",
                "name": "Jessica",
                "avatar": null,
                "email": "Jessica@qq.com",
                "sign": "just a little try"
            },
            "block": {
                "id": 1,
                "name": "博雅"
            }
        }
    ]
}
```

### 获取组织信息 `organizations/`

- 获取所有组织以及组织的详细信息

- 参数 放到query_params http://127.0.0.1:8000/organizations/?org=Org2

  ```json
  {
  	"org" : "Org2",
  }
  ```

  若无参数，则返回所有组织的详细信息

- 返回

  - 有参数

  ```json
  {
      "status": 0,
      "msg": "ok",
      "results": {
          "name": "Org2",
          "description": "aba aba aba",
          "create_time": "2021-04-13T12:02:47.699920",
          "avatar": "url",
          "owner": {
              "id": 1,
              "openid": "12345",
              "name": "Jessica",
              "avatar": null,
              "email": "Jessica@qq.com",
              "sign": "just a little try"
          },
          "block": {
              "id": 1,
              "name": "博雅"
          }
      }
  }
  ```

  - 有参数 报错

  ```json
  {
      "status": 1,
      "msg": "invalid org name"
  }
  ```

  - 无参数

  ```json
  {
      "status": 0,
      "msg": "ok",
      "results": [
          {
              "name": "Org1",
              "description": "this is Org1",
              "create_time": "2021-04-13T12:01:47.643533",
              "avatar": "url",
              "owner": {
                  "id": 1,
                  "openid": "12345",
                  "name": "Jessica",
                  "avatar": null,
                  "email": "Jessica@qq.com",
                  "sign": "just a little try"
              },
              "block": {
                  "id": 1,
                  "name": "博雅"
              }
          },
          {
              "name": "Org2",
              "description": "aba aba aba",
              "create_time": "2021-04-13T12:02:47.699920",
              "avatar": "url",
              "owner": {
                  "id": 1,
                  "openid": "12345",
                  "name": "Jessica",
                  "avatar": null,
                  "email": "Jessica@qq.com",
                  "sign": "just a little try"
              },
              "block": {
                  "id": 1,
                  "name": "博雅"
              }
          }
      ]
  }
  ```

  

### 查看指定组织的所有管理员 `organizations/managers/`

- 根据组织名称查看所有管理员

- 参数 放到query_params，若无则返回所有组织-管理员

  ```
  {
  	"org" : "Org2",
  }
  ```

- 返回

  - 有参数，有组织管理员

  ```json
  {
      "status": 0,
      "msg": "ok",
      "results": [
          {
              "org": {
                  "name": "Org1",
                  ...
              },
              "person": {
                  "id": 1,
                  "openid": "12345",
                  "name": "Jessica",
                  "avatar": null,
                  "email": "Jessica@qq.com",
                  "sign": "just a little try"
              }
          },
          {
              "org": {
                  "name": "Org1",
                 ...
              },
              "person": {
                  "id": 2,
                  "openid": "23456",
                  "name": "jessie",
                  "avatar": null,
                  "email": "jessir@qq.com",
                  "sign": "mio mio~"
              }
          }
      ]
  }
  ```

  - 有参数 无组织管理员

    ```json
    {
        "status": 0,
        "msg": "ok",
        "results": []
    }
    ```

  - 有参数报错

    ```json
    {
        "status": 1,
        "msg": "invalid org name"
    }
    ```

  - 无参数 返回所有

    ```json
    {
        "status": 0,
        "msg": "ok",
        "results": [
            {
                "org": {
                    "name": "Org1",
                    ...
                },
                "person": {
                    "id": 1,
                    "openid": "12345",
                    "name": "Jessica",
                    "avatar": null,
                    "email": "Jessica@qq.com",
                    "sign": "just a little try"
                }
            },
            {
                "org": {
                    "name": "Org1",
                   ...
                },
                "person": {
                    "id": 2,
                    "openid": "23456",
                    "name": "jessie",
                    "avatar": null,
                    "email": "jessir@qq.com",
                    "sign": "mio mio~"
                }
            }
        ]
    }
    ```

    

### 查看当前用户信息 `users/`

- 根据前端给的用户id查看当前用户信息
- 参数 放到query_params http://127.0.0.1:8000/users?id=2

```json
{
	"id" : 2,
}
```

- 返回

```json
{
    "status": 0,
    "msg": "ok",
    "results": {
        "id": 2,
        "openid": "23456",
        "name": "jessie",
        "avatar": null,
        "email": "jessir@qq.com",
        "sign": "mio mio~"
    }
}
```

报错

```json
{
    "status": 1,
    "msg": "invalid userID"
}
```

### 查看用户管理的所有组织 `users/organizations/`

- 查看当前用户管理的所有组织信息

- 参数 放到query_params

  ```json
  {
  	"id" : 2,
      'user_view':True  #这个必须设为True，区别通过组织查管理员
  }
  ```

- 返回

  - 有管理组织

    ```json
    {
        "status": 0,
        "msg": "ok",
        "results": [
            {
                "org": {
                    "name": "Org1",
                    "description": "this is Org1",
                    "create_time": "2021-04-13T12:01:47.643533",
                    "avatar": "url",
                    "owner": {
                        "id": 1,
                        "openid": "12345",
                        "name": "Jessica",
                        "avatar": null,
                        "email": "Jessica@qq.com",
                        "sign": "this is my new sign!"
                    },
                    "block": {
                        "id": 1,
                        "name": "博雅"
                    }
                },
                "person": {
                    "id": 1,
                    "openid": "12345",
                    "name": "Jessica",
                    "avatar": null,
                    "email": "Jessica@qq.com",
                    "sign": "this is my new sign!"
                }
            }
        ]
    }
    ```

  - 无管理组织

    ```json
    {
        "status": 0,
        "msg": "ok",
        "results": []
    }
    ```

  - 报错

    ```json
    {
        "status": 1,
        "msg": "invalid userID"
    }
    ```

    

  

## PUT

### 用户信息修改 `users/`

- 当前用户修改头像、昵称、签名信息

- 参数 

  - query_params存放id

    ```json
    {
    	"id" : 2,
    }
    ```

  - data(body)存放修改信息

  ```json
  {
      "sign":"new sign!"
  }
  ```

- 返回

  - 正常

    ```json
    {
        "status": 0,
        "msg": "ok",
        "results": {
            "id": 1,
            "openid": "12345",
            "name": "Jessica",
            "avatar": null,
            "email": "Jessica@qq.com",
            "sign": "this is my new sign!"
        }
    }
    ```

  - 报错

    ```json
    {
        "status": 1,
        "msg": "invalid userID"
    }
    ```

    

  

